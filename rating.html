<!DOCTYPE html>
<html lang="en">
<!--rating.html-->
<head>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="-1">
    <meta charset="utf-8"/>
    <title> Holy Tomatoes | Church Event Rating Engine</title>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0"/>
    <link href="styles/ht.css" type="text/css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,700,900' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Arimo:400,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="node_modules/jquery-treegrid/styles.css">
    <link rel="stylesheet" href="styles/default.min.css">
    <link rel="stylesheet" href="node_modules/jquery-treegrid/css/jquery.treegrid.css">
    <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <style>
        a {
            font-size: 10pt;
            font-family: Times Roman;
        }

        body {
            background-size: 100%;
        }

        #userprofile {
            border: 1px solid navy;
            float: left;
            width: '100%';
        }

        img {
            width: 90;
            height: 80px
        }

        #userrating {
            border: 1px solid maroon;
            vertical-align: top;
            width: '100%';
        }

        input {
            font-size: 12px;
            font-family: Verdana;
            border: none;
        }

        .slider {
            color: maroon;
        }

        .category {
            font-family: arial;
            font-style: italic;
            font-weight: bold;
            font-size: 12px;
            color: maroon;
        }

        .score {
            font-family: verdana;
            font-size: 12pt;
            color: navy;
            text-align: right;
        }

        #ratingchurch {
            border: solid 1px navy;
            vertical-align: top;
        }

        .rating-church {
            font-family: verdana;
            font-size: 12pt;
        }

        #comments {
            font-style: italic;
            font-family: Times Roman;
            font-size: 10pt;
            color: navy;
        }

         #churchratingcount {
            border: solid 1px maroon;
            text-align: right;
            font-family: Times Roman;
            font-size: 10pt;
            color: navy;
            padding-right: 3px;
            vertical-align: top;
        }

        #church-name {
            vertical-align: top;
            text-align: right
        }

        #commentstatus {
            color: navy;
            border: solid 1px black;
            padding: 1px;
        }

        #ratingnow {
            vertical-align: top;
        }

        #treeGrid {
            margin-left: 3px;
            width: '100%';
        }

        #warnings {
            width: '100%';
            border: solid 1px red;
            font-style: italic;
        }

        #rstatus {
            font-family: Times Roman;
            font-size: 10pt;
            color: blue;
            font-style: italic;
        }

         .regular {
            font-family: Arial;
            font-style: normal;
            color: maroon;
            font-size: 12px;
            padding: 2px;
            width: 400px;
            height: 26px;
            border: solid 1px #C03030;
            box-shadow: inset 1px 1px 1px 0 #C03030;
            transition: box-shadow 0.3s;
        }

        .regular input[type="text"]:focus,
        .regular input[type="text"].focus {
            box-shadow: inset 1px 1px 1px 0 #c9c9c9;
        }

        .htbutton {
            background: #3dc0c0;
            background-image: -webkit-linear-gradient(top, #cdc0c0, #2980b9);
            background-image: -moz-linear-gradient(top, #cdc0c0, #2980b9);
            background-image: -ms-linear-gradient(top, #cdc0c0, #2980b9);
            background-image: -o-linear-gradient(top, #cdc0c0, #2980b9);
            background-image: linear-gradient(to bottom, #cdc0c0, #2980b9);
            -webkit-border-radius: 10;
            -moz-border-radius: 10;
            border-radius: 10px;
            font-family: Arial;
            color: #ffffff;
            font-size: 10px;
            padding: 2px 4px 2px 2px;
            text-decoration: none;
            text-align: center
        }

        .htbutton:hover {
            background: #3dc0c0;
            background-image: -webkit-linear-gradient(top, #cdc0c0, #3498db);
            background-image: -moz-linear-gradient(top, #cdc0c0, #3498db);
            background-image: -ms-linear-gradient(top, #cdc0c0, #3498db);
            background-image: -o-linear-gradient(top, #cdc0c0, #3498db);
            background-image: linear-gradient(to bottom, #cdc0c0, #3498db);
            text-decoration: none;
        }</style>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title id='Description'>jHoly Tomatoes Church Event Rating</title>
        <link rel="stylesheet" href="css/rating.css">
        <link rel="stylesheet" href="jqTree/jqtree.css">
        <link rel="stylesheet" href="node_modules/jquery-treegrid/styles.css">
        <link rel="stylesheet" href="styles/default.min.css">
        <link rel="stylesheet" href="node_modules/jquery-treegrid/css/jquery.treegrid.css">
        <link rel="stylesheet" href="jq/jqwidgets/styles/jqx.base.css" type="text/css"/>
        <link rel="stylesheet" href="jq/jqwidgets/styles/jqx.summer.css" type="text" />
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&signed_in=true"></script>
        <script type="text/javascript" src="jq/scripts/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="jq/scripts/demos.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxcore.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxwindow.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxdatetimeinput.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxcalendar.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxtooltip.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/globalization/globalize.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxdocking.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxlistbox.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxscrollbar.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxbuttons.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxinput.js"></script>
        <script type="text/javascript" src="js/js.cookie.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxdropdownlist.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxslider.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxdropdownbutton.js"></script>
        <script src="jqTree/tree.jquery.js"></script>
        <script type="text/javascript" src="jquery-dateFormat/dist/jquery-dateFormat.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxmenu.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxcheckbox.js"></script>
        <script type="text/javascript" src="jq/scripts/json2.js"></script>
        <script type="text/javascript" src="jq/jqwidgets/jqxdata.js"></script>

        <script type="text/javascript" src="jq/jqwidgets/jqxdatatable.js"></script>
        <script type="text/javascript" src="jq/scripts/demos.js"></script>
        <script src="jqTree/tree.jquery.js"></script>
        <script type="text/javascript">
            var peerSurveyForm;
            var church = {
                "name": "",
                "domain": "",
                "street": " ",
                "city": "",
                "province": "",
                "postalcode": "",
                "country": "US",
                "placeid": "",
                "phone": "",
                "website": "",
                "vicinity": "here",
                "address": "",
                "source": "",
                "status": "ok",
                "action": "",
                "error": "",
                "sql": "",
                "id": 0
            };
            var userStub = {
                "firstname": "",
                "lastname": "",
                "email": "",
                "password": "",
                "placeid": "",
                "churchname": "",
                "churchadmin": "",
                "id": 0,
                "churchid": 0,
                "status": "ok",
                "action": "",
                "error": "",
                "sql": "",
                "objectid": "",
                "webserver": ""
            };
            var thechurch = church;
            var place;
            var map;
            var marker;
            var ChurchData;
            var geocoder;
            var infowindow;
            var autocomplete;
            var ChurchEvents;
            var ChurchRatingProfile;
            var ChurchRatings; // my church
            var UserRatingsChanged = false;
            var CannotRate = false;
            var EventinCore;
            var ChurchDetail;
            var RatinginCore;
            var RatinginSession = false;
            var go = 0;
            var nextIndex = 0
            var online;
            var webserver;
            var jData = [];
            var jChurch = [];

        </script>

        <script type="text/javascript">
            function initialize() {
                var mapOptions = {
                    //   center: {lat: -33.8688, lng: 151.2195},
                    zoom: 13
                };
                map = new google.maps.Map(document.getElementById('church-map'), mapOptions);
                var input = (document.getElementById('pac-input'));
                autocomplete = new google.maps.places.Autocomplete(input);
                autocomplete.bindTo('bounds', map);
//  map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
                infowindow = new google.maps.InfoWindow();
                marker = new google.maps.Marker({
                    map: map
                });
                google.maps.event.addListener(marker, 'click', function () {
                    infowindow.open(map, marker);
                });

                google.maps.event.addListener(autocomplete, 'place_changed', function () {
                    infowindow.close();
                    place = autocomplete.getPlace();
                    if (!place.geometry) {
                        return;
                    }
                    // Set the position of the marker using the place ID and location
                    marker.setPlace(({placeId: place.place_id, location: place.geometry.location}));
                    marker.setVisible(false);
// stuff place data in JSON object


                    if (($.inArray('church', place.types) != -1) || ($.inArray('place_of_worship', place.types) != -1)) {
                        thechurch.name = place.name;
                        thechurch.placeid = place.place_id;
                        thechurch.address = place.formatted_address;
                        ChurchData = thechurch.address.split(",");
                        ChurchData.length = 5;
                        thechurch.country = $.trim(ChurchData[3]);
                        thechurch.street = $.trim(ChurchData[0]);
                        thechurch.city = $.trim(ChurchData[1]);
                        thechurch.province = $.trim(ChurchData[2]);
                        zippy = thechurch.province.split(" ");
                        if (zippy.length > 1) {
                            thechurch.province = $.trim(zippy[0]);
                            ChurchData[2] = thechurch.province;
                            thechurch.postalcode = $.trim(zippy[1]);
                            ChurchData[4] = thechurch.postalcode;
                        }
//  //    
                        if (place.website != null) {
                            thechurch.website = $.trim(place.website);
                        } else {
                            thechurch.website = '';
                        }
//
                        if (place.formatted_phone_number != null) {
                            thechurch.phone = $.trim(place.formatted_phone_number);
                        } else {
                            thechurch.phone = '';
                        }
                        var url = $.trim(thechurch.website);
                        if (url != '') {
                            var domain = url.replace('http://', '').replace('https://', '').replace('www.', '').split(/[/?#]/)[0];
                            thechurch.domain = domain.replace('http://', '').replace('https://', '').split(/[/?#]/)[0];
                        }
                        if (!isEmpty(domain)) {
                            $('#pac-input').val(church.name);
                            $('#domain').val(domain);
                            $('#churchid').val(0);
                            $('#GoogleMap').val(place.place_id);
                            $('#address').val(thechurch.street);
                            $('#city').val(thechurch.city);
                            $('#province').val(thechurch.province);
                            $('#postalcode').val(thechurch.postalcode);
                            $('#phone').val(thechurch.phone);
                            $('#country').val(thechurch.country);
                            $('#website').val(thechurch.website);
                            $('#ChurchName').val(thechurch.name);
                            $.ajax({
                                crossdomain: true,
                                data: $('#churchform').serialize(),
                                dataType: 'html',
                                type: 'post',
                                url: webserver + ':8080/churches/manage/register',
                                processData: false,
                                cache: false,
                                success: function (data) {
                                    var result = JSON.parse(data);
                                    if (result.status == 'ok') {
                                        thechurch.id = parseInt(result.churchid);
                                        stuff = '<small><b>' + thechurch.name + '</b><br>' + ChurchData[0] + '<br>' + ChurchData[1] + ',&nbsp;' + ChurchData[2] + '<br>' + thechurch.phone + '</small>';
                                        $('#church-name').html(stuff);
                                        $('#pac-input').val(thechurch.name);
                                        getChurchRatingData();
                                        $('#churchratings').hide(1000);
                                    } else {
                                        alert('Problem reconciling ' + church.name + ' in HT database. Error: ' + result.error);
                                        console.log(result.status);
                                        console.log(result.error);
                                        console.log(result.sql);
                                    }
                                },
                                error: function (result) {
                                    alert('Error in Church Google Map Lookup: ' + result.error);
                                }
                            });
                        } else {
                            alert(church.name + ' does not appear to have a valid domain name');
                        }
                    } else {
                        alert(place.name + ' does not appear to be a valid church.');
                    }
                });
            }
        </script>
        <script type="text/javascript">
            function showmap() {
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                }
                else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(12);
                }
                // Set the position of the marker using the place ID and location
                marker.setPlace(/** @type {!google.maps.Place} */ ({
                    placeId: place.place_id,
                    location: place.geometry.location
                }));
                marker.setVisible(true);
            }
        </script>

        <script type="text/javascript">
            // data retieval functions
            function getChurchRatingData() {
                $('#ratingnow').css('border', 'none');
                $.ajax({
                    crossdomain: true,
                    type: 'get',
                    url: webserver + ':8080/churches/getevents/' + church.id
                }).success(function (data) {
                    if (!isEmpty(data)) {
                        if (data.length > 1) {
                            ChurchEvents = data;
                            BuildEventList();
                            ChurchRatings = data;
                            RatinginSession = false;
                            UserRatingsChanged = false;
                            getChurchRatingStats(church.id);
                        } else {
                            console.log('Not found');
                            $('#warnings').css({"border-color": "red", "visibility": "visible"});
                            $('#warnings').html('Houston! we have a problem ' + data.error);
                        }
                    } else {
                        console.log('Error with db access');
                        $('#warnings').css({"border-color": "red", "visibility": "visible"});
                        $('#warnings').html('Houston! we have a problem with events for ' + userStub.churchname);
                    }
                });
            }
            function getChurchDataWithID(cid) {
                $.ajax({
                    crossdomain: true,
                    type: 'get',
                    url: webserver + ':8080/churches/getdata/' + cid
                }).success(function (data) {
                    if (!isEmpty(data)) {
                        if (data.status == "ok") {
                            ChurchDetail = data;
                            stuff = '<b>' + ChurchDetail.churchname + '</b><br>' + ChurchDetail.address + '<br>' + ChurchDetail.city + ',&nbsp;' + ChurchDetail.state + '&nbsp;' + ChurchDetail.zipcode;
                            $('#church-name').html(stuff);
                        } else {
                            alert('Data Not Found ' + data.status);
                        }
                    } else {
                        alert('Data Access problem - No results returned');
                    }
                });
            }
            //
            function getExpandedUserRatings(trate) {
                $('#treeGrid').show();
                cancelRating(100);
                $('#treeGrid').children().remove();
// 	    $('#treeGrid').append('<iframe width="850" height="400" src="mongoTree.html" frameborder="0"></iframe>');
                getUserRatings();

            }

        </script>
        <script type="text/javascript">

            // This function is called when the user clicks the UI button requesting
            // a reverse geocode.
            function geocodePlaceId(placeId) {
                var map = new google.maps.Map(document.getElementById('user-church-map'), {
                    zoom: 8,
                });
                var ok = false;
                var geocoder = new google.maps.Geocoder;
                var infowindow = new google.maps.InfoWindow;
                geocoder.geocode({'placeId': placeId}, function (results, status) {
                    if (status === google.maps.GeocoderStatus.OK) {
                        if (results[0]) {
                            map.setZoom(11);
                            map.setCenter(results[0].geometry.location);
                            var marker = new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location
                            });
                            infowindow.setContent(results[0].formatted_address);
                            infowindow.open(map, marker);
                            ok = true;
                        } else {
                            alert('No results found');
                        }
                    } else {
                        alert('Geocoder failed due to: ' + status);
                    }
                    return ok;
                });
            }
        </script>
        <script type="text/javascript">
            //*******************************************************************************
            // data save functions
            // ******************************************************************************


            function saveRatings() {
                if (confirm("Do you wish to save your ratings on " + EventinCore.eventname + "?")) {
                    $('#warnings').html('&nbsp;');
                    $('#warnings').css({"border-color": "navy", "visibility": "hidden"});
// determine the next index to assign to the event in the member.ratings array           	
                    var scorecount = 0;
                    var scoretotal = 0;
                    var dtzCount = 0;
                    // determine the aggregate score for the questions answered
                    for (i = 0; i < RatinginCore.length; i++) {
                        scoretotal += RatinginCore[i].score;
                        if (RatinginCore[i].dtz == true && RatinginCore[i].score == 0) {
                            dtzCount++;
                        }
                        scorecount++;
                    }
// create document for insertion into db.members.member.ratings[]   
                    nextIndex++;
                    var rdoc = {
                        "_index": nextIndex,
                        "churchname": church.name,
                        "churchid": church.id,
                        "eventname": EventinCore.eventname,
                        "eventid": EventinCore.eventid,
                        "eventdate": EventinCore.startdate,
                        "score": scoretotal / scorecount,
                        "comments": $('#opinion').val(),
                        "daterated": Date(),
                        "userid": userStub.id,
                        "churchid": church.id,
                        "eventid": EventinCore.eventid,
                        "questions": []
                    };
                    // stuff the questions and scores in the sub document {member.ratings[]}
                    qTotal = 0;
                    var question;
                    for (i = 0; i < RatinginCore.length; i++) {
                        question = {"question": RatinginCore[i].category, "score": RatinginCore[i].score};
                        qTotal += RatinginCore[i].score;
                        rdoc.questions.push(question);
                    }
                    // insert the sub document in member.ratings document array
                    if (qTotal > 0) {
                        $.ajax({
                            crossdomain: true,
                            type: 'post',
                            contentType: "application/json",
                            url: webserver + ':8080/members/saverating/' + JSON.stringify(rdoc)
                        }).success(function (data) {
                            if (!isEmpty(data)) {
                                if (data.status == "ok") {
                                    stuff = '<small><b>' + thechurch.name + '</b><br>' + ChurchData[0] + '<br>' + ChurchData[1] + ',&nbsp;' + ChurchData[2] + '<br>' + thechurch.phone + '</small>';
                                    $('#church-name').html(stuff);
                                    console.log('Document saved successfully');
                                } else {
                                    alert('Unable to save this session: ' + data.status);
                                }
                            } else {
                                alert('Data Access problem - No results returned');
                            }
                        });
                    } else {
                        alert('No Questions have been scored, cancelling!');
                    }
                } else {
                    console.log("Save aborted!");
                }
            }


            //****************************************************************************
            //Data Retrieval functions
            //*****************************************************************************
            //getChurchRatingStats
            function getChurchRatingStats(ChurchID) {
                $.ajax({
                    crossdomain: true,
                    type: 'get',
                    url: webserver + ':8080/churches/ratingstats/' + ChurchID
                }).success(function (data) {
                    if (!isEmpty(data)) {
                        ChurchRatingStats = data;
                        //                 alert('User Ratings Analog: '+ UserRatings[1].userid);
                        if (data.status == 'ok') {
                            stuff = 'Total Events Rated: ' + ChurchRatingStats.rcount + '<br> Total Persons Rating: ' + ChurchRatingStats.mcount + '<br>Total Categories Scored: ' + ChurchRatingStats.qcount + '<br> Average Score: ' + ChurchRatingStats.score.toFixed();
                        } else {
                            stuff = '<p style="color:red"><b><small>0 events</small></b></p>';
                        }
                        $('#churchratingcount').html(stuff);
                    } else {
                        console.log('Data Retrieval Error ' + data.error);
                    }
                });
            }

        </script>
    </head>
<body class='default'>
<header>
    <div class="navbar">
        <div class="navbar-top">
            <div class="navbar-inner">
                <div class="container">
                    <h1><a href="" id="logo"><img src="images/logo.png" alt="Holy Tomtatoes"/></a></h1>

                    <nav id="main" width="100%">
                        <a href="login.html" id="mobile-link" title="Login">Login</a> <a href="login.html"
                                                                                         id="menu-icon"></a>
                        <ul>
                            <li><a href="javascript:outahere(1);" title="Home">Home</a></li>
                            <li><a href="javascript:outahere(2);" title="Change basic user profile attributes">My
                                Stub</a></li>
                            <li><a href="#" title="FAQ">FAQ</a></li>
                            <li><a href="#" title="Contact Us">Contact Us</a></li>
                            <li><a href="javascript:outahere(3);" title="Logout">Logout</a></li>
                        </ul>
                    </nav>

                </div> <!--Container End -->
            </div> <!--Navbar-inner End -->
        </div> <!--Navbar-top End -->
    </div> <!--Navbar End -->

</header>
<div id="userprofile">
    <table id="usertable" width="100%">
        <tr>
            <td width="10%"> <!-- Cell 1 -->
                <div>
                    <img id="htuser" title="Holy Tomatoes User" height="81px" width="144px" align="center"
                         src="server/php/files/blank.jpg">
                </div>
            </td>
            <td width="25%"> <!-- Cell 2 -->
                <table>
                    <tr>
                        <td>
                            <div id="userinfo">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="rstatus">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="mychurch">
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
            <td width="5%"> <!-- Cell 3 -->
                <table>
                    <tr>
                        <td>
                            <div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                </table>
            </td>
            <td width="30%" style="text-align:right"> <!-- Cell 4 -->
                <table>
                    <tr>
                        <td>
                            <div id="church-name">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="churchaddress">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="church-map">
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
            <td width="30%"> <!-- Cell 5 -->
                <table>
                    <tr>
                        <td>
                            <div id="churchratingcount">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                        </td>
                    </tr>
                </table>
            </td>
            <td width="10%"> <!-- Cell 6 -->
                <table>
                    <tr>
                        <td>
                            <div id="churchstat1">
                                <img src="jq/images/pieicon.png" title="" id="chart-pie">
                            </div>
                        </td>
                        <td>
                            <div id="churchstat2">
                                <img src="jq/images/stat.png" title="" id="chart-graph">
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    </td>
    </tr>
    </table>
</div>
<div id="userrating">
    <table style="vertical-align:top">
        <tr>

            <td style="vertical-align:top;" width="150">
                <div id="churchinput" style="vertical-align:top">
                    <input type="text" id="pac-input" placeholder="Rate a church" class="regular">
                </div>
            </td>
            <td style="vertical-align:top">
                <div id="churchevents" style="float:left;vertical-align:top">
                </div>
            </td>
            <td style="vertical-align:top">
                <div id="ratingtime">
                    <div id="dateTimeInput" style="vertical-align:top;float:left;margin-left:4px;">
                    </div>
                    <div id="cancelrating" style="float:left;margin-left:2px">
                        <input type="button" class="htbutton" id="cancel" value="Cancel"
                               onclick="javascript:cancelRating(1000)">
                    </div>
                </div>
            </td>
            <td style="vertical-align:top">
            </td>
        <tr>
            <td style="vertical-align:top">
                <div id="ratingchurch">
                    <table style="vertical-align:top">
                        <tr>
                            <td>
                                <div id="ratinginfo">

                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="vertical-align:top">
                                <div id="comments">
                                </div>
                                <div id="commentstatus">

                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align:center">
                                <div id="saveratingbutton">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </td>
            <td colspan="2">
                <div id="ratingnow">
                    <table style="vertical-align:top">
                        <tr>
                            <td>
                                <span id="category0" class="category"></span>
                                <div id="slider0" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score0" class="score"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category1" class="category"></span>
                                <div id="slider1">
                                </div>
                            </td>
                            <td>
                                <div id="score1" class="score"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category2" class="category"></span></span>
                                <div id="slider2" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score2" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category3" class="category"></span></span>
                                <div id="slider3" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score3" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category4" class="category"></span></span>
                                <div id="slider4" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score4" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category5" class="category"></span></span>
                                <div id="slider5" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score5" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category6" class="category"></span></span>
                                <div id="slider6" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score6" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category7" class="category"></span></span>
                                <div id="slider7" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score7" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category8" class="category"></span></span>
                                <div id="slider8" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score8" class="score">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span id="category9" class="category"></span></span>
                                <div id="slider9" class="slider">
                                </div>
                            </td>
                            <td>
                                <div id="score9" class="score">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
        </tr>
    </table>
</div>
<table><tr><td width="50%"><div id="treeholder" style="float:left">
    <table>
        <tr>
            <td>
                <div id="person"></div>
            </td>
            <td>&nbsp; - &nbsp;</td>
            <td>
                <div id="rcount"></div>
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <div id="treeGrid"></div>
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <div id="tfooter"></div>
            </td>
        </tr>
    </table>
</div></td>
    <td width="50%" valign="top"><div id="chart" style="border: solid 1px #C03030"></div></td></tr></table>

<div id="data">
    <form id="churchform" name="cform">
        <input type="hidden" name="churchid" id="churchid"/>
        <input type="hidden" name="domain" id="domain"/>
        <input type="hidden" name="PlaceID" id="GoogleMap"/>
        <input type="hidden" name="address" id="address"/>
        <input type="hidden" name="city" id="city"/>
        <input type="hidden" name="province" id="province"/>
        <input type="hidden" name="postalcode" id="postalcode"/>
        <input type="hidden" name="phone" id="phone"/>
        <input type="hidden" name="website" id="website"/>
        <input type="hidden" name="country" id="country"/>
        <input type="hidden" name="ChurchName" id="ChurchName"/>
    </form>
</div>

<script type="text/javascript">
    //operational scripts
    $(document).ready(function () {
        online = Cookies.get('peaches');
        if (typeof(online) != "undefined") {
            userStub = $.parseJSON(online);
            webserver = userStub.webserver;
            if (userStub.placeid == '' && userStub.churchid == 0) {
                alert('This user has no Church Related Analogs');
                CannotRate = true;
            }
            if (isEmpty(webserver)) {
                alert('Unable to determine WebServer Address - Reload Page');
                $(location).attr('href', 'login.html');
            }
            var pic = "server/php/files/" + userStub.id + ".jpg";
            var nopic = "server/php/files/blank.jpg";
            $.get(pic).done(function () {
                $('#htuser').attr('src', pic);
                $('#htuser').attr('width', '80px');
                $('#htuser').attr('height', '150px');
                $('#htuser').attr('title', userStub.firstname + ' ' + userStub.lastname);
            }).fail(function () {
                $('#htuser').attr('src', nopic);
            });
            $('#mychurch').html('<i>' + userStub.churchname + '</i>');
            $('#userinfo').html('<b>' + userStub.firstname + ' ' + userStub.lastname + '</b>');
            if (userStub.churchid > 0) {
                getChurchDataWithID(userStub.churchid);
                thechurch.id = userStub.churchid;
                thechurch.name = userStub.churchname;
                getChurchRatingStats(userStub.churchid);
                $('#chart-pie').attr('title', thechurch.name + ' visitor rating stats');
                $('#chart-pie').attr('height', '15px');
                $('#chart-pie').attr('width', '35px');
                $('#chart-graph').attr('title', thechurch.name + ' member survey info');
                $('#chart-graph').attr('height', '15px');
                $('#chart-graph').attr('width', '35px');
            }
            getExpandedUserRatings(1);
            // setup event date time input
            $("#dateTimeInput").jqxDateTimeInput({showTimeButton: true, width: '200px', height: '25px', theme: 'summer'});
            $("#dateTimeInput").jqxDateTimeInput({formatString: "MM/dd/yyyy hh:mm"});
            $('#dateTimeInput').change(function () {
                var day = $('#dateTimeInput').jqxDateTimeInput('getDate');
                stuff = '<p class="rating-church">You are currently rating <strong><i>' + EventinCore.eventname + '</i></strong> <br> at <strong>' + thechurch.name + '</strong><br> on <i><small>' + day + '</small></i>';
                $('#ratinginfo').html(stuff);
                EventinCore.startdate = day;//.toISOString().slice(0, 19).replace('T', ' ');
            });
            $(document).ajaxComplete(function (event, xhr, settings) {
                console.log(settings.url + ' has completed');
                console.log("<i>Triggered ajaxComplete handler. The result is " + xhr.responseText + "</i>");
                if (settings.url.match('.saverating.')) {
                    location.reload();
                    getExpandedUserRatings(1000);
                    getChurchRatingStats(thechurch.id);
                }
            });
            google.maps.event.addDomListener(window, 'load', initialize);
        } else {
            alert('Problem with User Account, Your session has probably expired, please log back in');
            $(location).attr('href', 'login.html');
        }
    });
</script>
<div id="footer-ft">
    <div class="wrap">
        <nav>
            <ul>
                <li>2015 Â© HOLY TOMATOES</li>
                <li><a href="#" title="Terms of Use">Terms of Use</a></li>
                <li><a href="#" title="Contact Us">Contact Us</a></li>
                <li><a href="#" title="Privacy Policy">Privacy Policy</a></li>
                <li><a href="http://www.holytomatoes.info" title="about">About</a></li>
            </ul>
            </ul>
        </nav>
    </div>
</div>
<br>
<div id="warnings">

</div>
<script type="text/javascript">

    function BuildEventList() {
        $('#churchratings').show();
        var el = '<select id="elist"><option value="0">Select Event</option>';
        for (i = 0; i < ChurchEvents.length; i++) {
            el += '<option value="' + ChurchEvents[i].eventid + '">' + ChurchEvents[i].eventname + '</option>';
        }
        el += '</select>';
        $('#churchevents').show();
        $('#churchevents').html(el);
        $('#elist').change(function () {
            RatinginCore = Array();
            if ($(this).val() > 0) {
                EventinCore = WhatIsEvent($(this).val());
                currentDate = Date.now();
                if (!isEmpty(EventinCore.startdate) && Date.parse(EventinCore.startdate) > currentDate) {
                    alert(EventinCore.eventname + ' does not occur until ' + EventinCore.startdate);
                } else {
                    getRatingsForEvent();
                    if (RatinginCore.length > 0) {
                        if (isEmpty(EventinCore.startdate) == false) {
                            $('#dateTimeInput').jqxDateTimeInput('setDate', EventinCore.startdate);
                            $('#dateTimeInput').jqxDateTimeInput({disabled: true});
                        } else {
                            $('#dateTimeInput').jqxDateTimeInput({disabled: false});
                        }
                        var day = $('#dateTimeInput').jqxDateTimeInput('getDate');
                        if (isEmpty(EventinCore.hyperlink) == false) {
                            stuff = '<p class="rating-church">You are currently rating <strong><i><a href="' + EventinCore.hyperlink + '" title="Watch ' + EventinCore.eventname + ' now!" target="_blank" >' + EventinCore.eventname + '</a></i></strong> <br> at <strong>' + thechurch.name + '</strong><br> on <i><small>' + day + '</small>';
                        } else {
                            stuff = '<p class="rating-church">You are currently rating <strong><i>' + EventinCore.eventname + '</i></strong> <br> at <strong>' + thechurch.name + '</strong><br> on <i><small>' + day + '</small></i>';
                        }
                        $('#dateTimeInput').jqxDateTimeInput('getDate') + '</small></i>';
                        $('#ratinginfo').html(stuff);
                        $('#saveratingbutton').html('<input type="submit" id="save" value="Save your ratings" onclick="javascript:saveRatings()">');
                        $('#comments').html('<textarea rows="8" cols="60" id="opinion" placeholder = "Enter your your comments here (Max 300 characters)"></textarea>');
                        $('#opinion').off('keyup').on('keyup', function () {
                            var len = $(this).val().length;
                            len = 300 - len;
                            $('#commentstatus').html('<i>Characters Remaining: ' + len + '</i>');
                            $('#opinion').css({padding: '2px'});
                        });
                        prepforRating();
                        buildratingUI();
                    } else {
                        alert('Sorry, no questions seem to exist for this event!');
                    }
                }
            }
        });
    }

    function WhatIsEvent(eventid) {
        for (i = 0; i < ChurchEvents.length; i++) {
            if (ChurchEvents[i].eventid == eventid) {
                return ChurchEvents[i];
            }
        }
    }

    //getRatingsForEvent

    function getRatingsForEvent() {
        var ok = true;
        if (UserRatingsChanged != true) {
            for (i = 0; i < EventinCore.questions.length; i++) {
                ok = true;
                if ((EventinCore.questions[i].memberonly == true) && (church.id != userStub.churchid)) {
                    ok = false;
                }
                if ((EventinCore.questions[i].visitoronly == true) && (church.id == userStub.churchid)) {
                    ok = false;
                }
                if (ok == true) {
                    var obj = {
                        "category": "",
                        "rank": 0,
                        "dtz": false,
                        "score": 0,
                        "visitoronly": false,
                        "memberonly": false,
                        "categoryid": 0
                    };
                    obj.category = EventinCore.questions[i].question;
                    obj.rank = EventinCore.questions[i].rank;
                    obj.dtz = Boolean(EventinCore.questions[i].dtz);
                    obj.visitoronly = Boolean(EventinCore.questions[i].visitoronly);
                    obj.memberonly = Boolean(EventinCore.questions[i].memberonly);
                    obj.categoryid = EventinCore.questions[i].categoryid;
                    RatinginCore.push(obj);
                }
            }
            RatinginCore.sort(function (a, b) {
                var nameA = a.rank, nameB = b.rank;
                if (nameA > nameB) {
                    return 1;
                } else if (nameA < nameB) {
                    return -1;
                } else {
                    return 0;
                }
            })
        }
    }

    function outahere(option) {
        if (userStub.status == 'changed' && userStub.churchid > 0) {
            if (updateuserid() == false) {
                alert('Problem encountered with housekeeping!');
            }
        }
        goodhousekeeping();
        switch (option) {
            case 1:
                window.location.href = webserver + "/index.html";
                break;
            case 2:
                window.location.href = webserver + "/register.html";
                break;
            case 3:
                var Browser = navigator.appName;
                var indexB = Browser.indexOf('Explorer');

                if (indexB > 0) {
                    var indexV = navigator.userAgent.indexOf('MSIE') + 5;
                    var Version = navigator.userAgent.substring(indexV, indexV + 1);

                    if (Version >= 7) {
                        window.open('', '_self', '');
                        window.close();
                    }
                    else if (Version == 6) {
                        window.opener = null;
                        window.close();
                    }
                    else {
                        window.opener = '';
                        window.close();
                    }

                }
                else {
                    window.close();
                }
                break;
            default:
                alert('Email Tech Support');
        }
    }
    function goodhousekeeping() {
        userStub.status = "";
        Cookies.set("peaches", JSON.stringify(userStub), {expires: 1});
    }
    function buildratingUI() {
        // $('#ratingnow').append('<table>');
        RatinginSession = true;
        prepforRating();
        $('#ratingnow').css('border', '1px solid maroon');
//    $('#ratingnow').css('visibility','visible')
        for (i = 0; i < RatinginCore.length; i++) {
            if (i <= RatinginCore.length) {
                switch (i) {
                    case 0:
                        $('#slider0').css('visibility', 'visible');
                        $('#category0').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider0').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider0').off('change').on('change', function (event) {
                            $('#score0').html('<i>' + $('#slider0').jqxSlider('value') + '</i>');
                            RatinginCore[0].score = $('#slider0').jqxSlider('value');
                            RatinginCore[0].status = "changed"
                            UserRatingsChanged = true;
                        });
                        break;
                    case 1:
                        $('#slider1').css('visibility', 'visible');
                        $('#category1').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider1').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider1').off('change').on('change', function (event) {
                            $('#score1').html('<i>' + $('#slider1').jqxSlider('value') + '</i>');
                            RatinginCore[1].score = $('#slider1').jqxSlider('value');
                            RatinginCore[1].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 2:
                        $('#slider2').css('visibility', 'visible');
                        $('#category2').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider2').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider2').off('change').on('change', function (event) {
                            $('#score2').html('<i>' + $('#slider2').jqxSlider('value') + '</i>');
                            RatinginCore[2].score = $('#slider2').jqxSlider('value');
                            RatinginCore[2].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 3:
                        $('#slider3').css('visibility', 'visible');
                        $('#category3').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider3').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider3').off('change').on('change', function (event) {
                            $('#score3').html('<i>' + $('#slider3').jqxSlider('value') + '</i>');
                            RatinginCore[3].score = $('#slider3').jqxSlider('value');
                            RatinginCore[3].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 4:
                        $('#slider4').css('visibility', 'visible');
                        $('#category4').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider4').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider4').off('change').on('change', function (event) {
                            $('#score4').html('<i>' + $('#slider4').jqxSlider('value') + '</i>');
                            RatinginCore[4].score = $('#slider4').jqxSlider('value');
                            RatinginCore[4].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 5:
                        $('#slider5').css('visibility', 'visible');
                        $('#category5').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider5').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider5').off('change').on('change', function (event) {
                            $('#score5').html('<i>' + $('#slider5').jqxSlider('value') + '</i>');
                            RatinginCore[5].score = $('#slider5').jqxSlider('value');
                            RatinginCore[5].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 6:
                        $('#slider6').css('visibility', 'visible');
                        $('#category6').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider6').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider6').off('change').on('change', function (event) {
                            $('#score6').html('<i>' + $('#slider6').jqxSlider('value') + '</i>');
                            RatinginCore[6].score = $('#slider6').jqxSlider('value');
                            RatinginCore[6].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 7:
                        $('#slider7').css('visibility', 'visible');
                        $('#category7').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider7').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider7').off('change').on('change', function (event) {
                            $('#score7').html('<i>' + $('#slider7').jqxSlider('value') + '</i>');
                            RatinginCore[7].score = $('#slider7').jqxSlider('value');
                            RatinginCore[7].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 8:
                        $('#slider8').css('visibility', 'visible');
                        $('#category8').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider8').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider8').off('change').on('change', function (event) {
                            $('#score8').html('<i>' + $('#slider8').jqxSlider('value') + '</i>');
                            RatinginCore[8].score = $('#slider8').jqxSlider('value');
                            RatinginCore[8].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                    case 9:
                        $('#slider9').css('visibility', 'visible');
                        $('#category9').html('&nbsp;' + RatinginCore[i].category + '&nbsp;');
                        $('#slider9').jqxSlider({tooltip: true, mode: 'fixed'});
                        $('#slider9').off('change').on('change', function (event) {
                            $('#score9').html('<i>' + $('#slider9').jqxSlider('value') + '</i>');
                            RatinginCore[9].score = $('#slider9').jqxSlider('value');
                            RatinginCore[9].status = "changed";
                            UserRatingsChanged = true;
                        });
                        break;
                } // switch
            }
        }
    }
    function prepforRating() {
        $('#treeGrid').hide();
        $('#ratingnow').show();
        $('#ratingchurch').show();
        UserRatingsChanged = false;
        for (i = 0; i < 10; i++) {
            switch (i) {
                case 0:
                    $('#slider0').jqxSlider({value: 0});
                    $('#slider0').css('visibility', 'hidden');
                    $('#category0').html('&nbsp;');
                    $('#score0').html('&nbsp;');
                    break;
                case 1:
                    $('#slider1').jqxSlider({value: 0});
                    $('#slider1').css('visibility', 'hidden');
                    $('#category1').html('&nbsp;');
                    $('#score1').html('&nbsp;');
                    break;
                case 2:
                    $('#slider2').jqxSlider({value: 0});
                    $('#slider2').css('visibility', 'hidden');
                    $('#category2').html('&nbsp;');
                    $('#score2').html('&nbsp;');
                    break;
                case 3:
                    $('#slider3').jqxSlider({value: 0});
                    $('#slider3').css('visibility', 'hidden');
                    $('#category3').html('&nbsp;');
                    $('#score3').html('&nbsp;');
                    break;
                case 4:
                    $('#slider4').jqxSlider({value: 0});
                    $('#slider4').css('visibility', 'hidden');
                    $('#category4').html('&nbsp;');
                    $('#score4').html('&nbsp;');
                    break;
                case 5:
                    $('#slider5').jqxSlider({value: 0});
                    $('#slider5').css('visibility', 'hidden');
                    $('#category5').html('&nbsp;');
                    $('#score5').html('&nbsp;');
                    break;
                case 6:
                    $('#slider6').jqxSlider({value: 0});
                    $('#slider6').css('visibility', 'hidden');
                    $('#category6').html('&nbsp;');
                    $('#score6').html('&nbsp;');
                    break;
                case 7:
                    $('#slider7').jqxSlider({value: 0});
                    $('#slider7').css('visibility', 'hidden');
                    $('#category7').html('&nbsp;');
                    $('#score7').html('&nbsp;');
                    break;
                case 8:
                    $('#slider8').jqxSlider({value: 0});
                    $('#slider8').css('visibility', 'hidden');
                    $('#category8').html('&nbsp;');
                    $('#score8').html('&nbsp;');
                    break;
                case 9:
                    $('#slider9').jqxSlider({value: 0});
                    $('#slider9').css('visibility', 'hidden');
                    $('#category9').html('&nbsp;');
                    $('#score9').html('&nbsp;');
                    break;
            }

        }
    }
</script>
<script type="text/javascript">
    function getUserRatings() {
        var person = 'Nobody';
        $.ajax({
            crossdomain: true,
            type: 'get',
            url: webserver + ':8080/members/ratings/' + userStub.id
        }).success(function (data) {
            if (!isEmpty(data)) {
                if (data.length > 0) {
                    data.sort(function (a, b) {
                        var nameA = a.churchname.toLowerCase(), nameB = b.churchname.toLowerCase();
                        if (nameA > nameB) {
                            return 1;
                        } else if (nameA < nameB) {
                            return -1;
                        } else {
                            return 0;
                        }
                    });
                    var stats = buildTree(data);
                    nextIndex = stats.ecount;
                    $('#person').html("&nbsp; - &nbsp;" + userStub.firstname + " " + userStub.lastname + "'s rating history.");
                    $('#rcount').html('<i>' + stats.ccount + ' churches visited - Total events rated: ' + stats.ecount + ' </i>');
                    $('#treeGrid').tree({
                        data: jData,
                        closedIcon: '+',
                        openedIcon: '-',
                        autoOpen: false
                    });
                    $('#treeGrid').bind('tree.click', function (event) {
                        // The clicked node is 'event.node'
                        var node = event.node;
//                  thechurch.id = jChurch[node.id-1];
                        getChurchRatingStats(jChurch[node.id - 1]);
                        getChurchDataWithID(jChurch[node.id -1]);
                    });
                    Cookies.set("peaches", JSON.stringify(userStub), {expires: 1});
                } else {
                    console.log('Data Not Found ' + data.status);
                }
            } else {
                console.log('Data Stack is empty -- Probably system error');
            }
        });
    }

    function buildTree(data) {
        var id = 1;
        var jNode;
        var jChildNode;
        var memberTag = '*';
        var eCount = 0;
        var cCount = 0;
        var ChurchInCore = data[0].churchid;
        if (data[0].churchid == userStub.churchid) {
            jNode = {"id": 1, "label": memberTag + data[0].churchname, "children": []};
        } else {
            jNode = {"id": 1, "label": data[0].churchname, "children": []};
        }
        jChildNode = {
            "id": 2,
            "label": data[0].eventname + ' on ' + $.format.date(data[0].eventdate, "MM/dd/yyyy hh:mm a") + ' | Score: ' + data[0].score.toFixed()
        };
        jNode.children.push(jChildNode)
        jChurch.push(ChurchInCore);
        id = 2;
        jChurch.push(ChurchInCore);
        eCount = 1;
        cCount = 1
        for (i = 1; i < data.length; i++) {
            if (data[i].churchid != ChurchInCore) {
                jChurch.push(data[i].churchid);
                jData.push(jNode)
                id++;
                cCount++;
                eCount++
                if (data[i].churchid == userStub.churchid) {
                    jNode = {"id": id, "label": memberTag + data[i].churchname, "children": []};
                    id++;
                    jChurch.push(data[i].churchid);
                } else {
                    jNode = {"id": id, "label": data[i].churchname, "children": []};
                    id++;
                    jChurch.push(data[i].churchid);
                }
                jChildNode = {
                    "id": id,
                    "label": data[i].eventname + ' on ' + $.format.date(data[i].eventdate, "MM/dd/yyyy hh:mm a") + ' | Score: ' + data[i].score.toFixed()
                };
                id++;
                jChurch.push(data[i].churchid);
                jNode.children.push(jChildNode)
                ChurchInCore = data[i].churchid;
            } else {
                id++;
                jChurch.push(data[i].churchid);
                jChildNode = {
                    "id": id,
                    "label": data[i].eventname + ' on ' + $.format.date(data[i].eventdate, "MM/dd/yyyy hh:mm a") + ' | Score: ' + data[i].score.toFixed()
                };
                jNode.children.push(jChildNode);
                eCount++;
            }
        }
        jData.push(jNode);
        for (i = 0; i < jData.length; i++) {
            if (jData[i].children.length > 1) {
                jData[i].label = jData[i].label + ' (' + jData[i].children.length + ')';
            }
        }
        return {"ecount": eCount, "ccount": cCount};
    }
    function cancelRating(trate) {
        $('#ratingnow').hide(trate);
        $('#ratingchurch').hide(trate);
        $('#treeGrid').show();
        $('#dateTimeInput').jqxDateTimeInput('setDate', $.now());
        $('#churchevents').hide();
    }
    function isEmpty(str) {
        return typeof str == 'string' && !str.trim() || typeof str == 'undefined' || str === null;
    }

</script>
</body>
</html>